---
title: "Receptor_dependence"
author: "Kenneth Matreyek"
date: "1/12/2021"
output: html_document
---

```{r Set up the analysis script}
rm(list = ls())
library(tidyverse)
theme_set(theme_bw())
library(ggrepel)
library(ggbeeswarm)
set.seed(1234567)
```

```{r Import the data}
combined_infection <- read.csv(file = "Data/Receptor_dependence_data.csv")

recombined_construct_key <- read.csv(file = "Data/Keys/Construct_label_key.csv", header = T, stringsAsFactors = F)
pseudovirus_label_key <- read.csv(file = "Data/Keys/Pseudovirus_label_key.csv", header = T, stringsAsFactors = F) #%>% filter(sequence_confirmed != "no")
```

```{r Quality filter the infection data}
# Two-color data
two_color_precombined <- combined_infection %>% filter(expt %in% c("Two_color", "Receptors", "ACE2_TMPRSS2", "Two_color_ACE2_TMPRSS2") & !(is.na(pseudovirus_env) | pseudovirus_env == "None"))
## Make sure I ignore data where I didn't run enough cells to make a conclusion
two_color_precombined$lower_bound_red <- 10^(log10(two_color_precombined$live_singlets * two_color_precombined$pct_red / 100)*-0.99 + 2.64)
two_color_precombined$lower_bound_nir <- 10^(log10(two_color_precombined$live_singlets * two_color_precombined$pct_nir / 100)*-0.99 + 2.64)
two_color_precombined$passes_lower_bound <- "no"
two_color_precombined$passes_upper_bound <- "no"
for(x in 1:nrow(two_color_precombined)){
  if(two_color_precombined$lower_bound_red[x] <= two_color_precombined$pct_grn_gvn_red[x] & two_color_precombined$lower_bound_nir[x] <= two_color_precombined$pct_grn_gvn_nir[x]){two_color_precombined$passes_lower_bound[x] <- "yes"}
  if(two_color_precombined$pct_grn_gvn_red[x] <= 60 & two_color_precombined$pct_grn_gvn_nir[x] <= 60){two_color_precombined$passes_upper_bound[x] <- "yes"}
}
two_color_combined <- merge(two_color_precombined %>% filter(passes_lower_bound == "yes" & passes_upper_bound == "yes"), pseudovirus_label_key, by = "pseudovirus_env", all.x = T) %>% mutate(ratio_nir_mcherry = pct_nir / pct_red)
```

```{r Load the initial dataset so I can make comparisons between one-color and two-color infection experiments}
original_infection_data <- read.csv(file = "Data/Infection_data.csv")
original_infection_data2 <- original_infection_data %>% filter(expt == "Kozaks" & recombined_construct %in% c("G758A", "G698C") & pseudovirus_env != "None")

original_infection_data2$lower_bound_red <- 10^(log10(original_infection_data2$live_singlets * original_infection_data2$pct_red / 100)*-0.99 + 2.64)
original_infection_data2$passes_lower_bound <- "no"
original_infection_data2$passes_upper_bound <- "no"
for(x in 1:nrow(original_infection_data2)){
  if(original_infection_data2$lower_bound_red[x] <= original_infection_data2$pct_grn_gvn_red[x]){original_infection_data2$passes_lower_bound[x] <- "yes"}
  if(original_infection_data2$pct_grn_gvn_red[x] <= 60){original_infection_data2$passes_upper_bound[x] <- "yes"}
}
original_infection_data3 <- merge(original_infection_data2 %>% filter(passes_lower_bound == "yes" & passes_upper_bound == "yes"), pseudovirus_label_key, by = "pseudovirus_env", all.x = T)

original_infection_data_summary <- data.frame(unique(original_infection_data3[,c("virus_label","date")]))
original_infection_data_summary$ace2_dependence <- NA
for(x in 1:nrow(original_infection_data_summary)){
  temp_date <- original_infection_data_summary$date[x]
  temp_env <- original_infection_data_summary$virus_label[x]
  original_infection_data_summary$ace2_dependence[x] <- mean(original_infection_data3[original_infection_data3$date == temp_date & original_infection_data3$virus_label == temp_env & original_infection_data3$recombined_construct == "G698C", "moi"]) / mean(original_infection_data3[original_infection_data3$date == temp_date & original_infection_data3$virus_label == temp_env & original_infection_data3$recombined_construct == "G758A", "moi"])
}

original_infection_data_summary2<- original_infection_data_summary %>% filter(ace2_dependence > 0)
```

## Seeing which receptors or proposed receptors actually enhance SARS-CoV-2 pseudovirus entry when overexpressed in HEK cells
```{r Using a combination of mCherry and iRFP670 to test which proteins help enhance SARS1 or SARS2 pseudovirus entry}
receptors <- two_color_combined %>% filter(expt == "Receptors" & recombined_construct != "CD209")
receptors$log10_nir_red_diff <- log10(receptors$moi_gvn_nir) - log10(receptors$moi_gvn_red)

## Collapsing all proteins to a single group, regardless of the tag
receptors$receptor_grouped <- NA
for(x in 1:nrow(receptors)){receptors$receptor_grouped[x] <- toupper(gsub("\\[HA]","",receptors$recombined_construct[x]))}

## Group by receptor, regardless of tag
receptors_grouped <- receptors %>% group_by(date, receptor_grouped, virus_label) %>% 
  summarize(log10_nir_red_diff = mean(log10_nir_red_diff), pct_grn_gvn_red = mean(pct_grn_gvn_red), pct_grn_gvn_nir = mean(pct_grn_gvn_nir), ratio_nir_mcherry = mean(ratio_nir_mcherry), .groups = "drop") %>% 
  mutate(n = 1, ace2dep_infection = 10^log10_nir_red_diff)

receptors_grouped_summary <- receptors_grouped %>% group_by(receptor_grouped, virus_label) %>% 
  summarize(mean_log10_nir_red_diff = mean(log10_nir_red_diff), sd_log10_nir_red_diff = sd(log10_nir_red_diff), n = sum(n), .groups = "drop") %>% 
  mutate(se_log10_nir_red_diff = sd_log10_nir_red_diff / sqrt(n), geomean = 10^mean_log10_nir_red_diff, lower_ci = 10^(mean_log10_nir_red_diff - se_log10_nir_red_diff * 1.96), upper_ci = 10^(mean_log10_nir_red_diff + se_log10_nir_red_diff * 1.96))
```

```{r Now comparing the one-color and two-color pseudovirus infection experiment formats for ACE2}
ggplot() + theme_bw() + scale_y_log10() + 
  geom_jitter(data = original_infection_data_summary2, aes(x = virus_label, y = ace2_dependence), width = 0.2)

ggplot() + theme_bw() + scale_y_log10() + 
  geom_jitter(data = receptors_grouped %>% filter(receptor_grouped == "ACE2"), aes(x = virus_label, y = ace2dep_infection), width = 0.2)

one_color_ace2_only_summary <- original_infection_data_summary2 %>% mutate(n = 1) %>% group_by(virus_label) %>% 
  summarize(mean_ace2_dep_infxn = mean(ace2_dependence), sd_ace2_dep_infxn = sd(ace2_dependence), n = sum(n), .groups = "drop") %>% 
  mutate(cv = sd_ace2_dep_infxn / mean_ace2_dep_infxn) %>% mutate(format = "one_color")

two_color_ace2_only_summary <- receptors_grouped %>% filter(receptor_grouped == "ACE2") %>% mutate(n = 1) %>% group_by(virus_label) %>% 
  summarize(mean_ace2_dep_infxn = mean(ace2dep_infection), sd_ace2_dep_infxn = sd(ace2dep_infection), n = sum(n), .groups = "drop") %>% 
  mutate(cv = sd_ace2_dep_infxn / mean_ace2_dep_infxn) %>% mutate(format = "two_color")

format_comparison <- rbind(one_color_ace2_only_summary, two_color_ace2_only_summary)

Coefficient_of_variation_plot <- ggplot() + theme_bw() + theme(panel.grid.major.x = element_blank()) +
  labs(x = NULL, y = "Coefficient of variation") +
  geom_text(data = format_comparison, aes(x = virus_label, y = cv + 0.1, color = format, label = n), position = position_dodge(width = 0.5)) +
  geom_point(data = format_comparison, aes(x = virus_label, y = cv, color = format), position = position_dodge(width = 0.5), shape = 95, size = 8) +
  geom_point(data = format_comparison, aes(x = virus_label, y = cv, color = format), position = position_dodge(width = 0.5))
Coefficient_of_variation_plot
ggsave(file = "Plots/Coefficient_of_variation_plot.pdf", Coefficient_of_variation_plot, height = 3, width = 6)
```

```{r Using a combination of mCherry and iRFP670 to test which proteins help enhance SARS1 or SARS2 pseudovirus entry}
receptors_virus_label_levels <- c("Vesicular stomatitis virus", "SARS-CoV", "SARS-CoV-2")
receptors_grouped$virus_label <- factor(receptors_grouped$virus_label, receptors_virus_label_levels)
receptors_grouped_summary$virus_label <- factor(receptors_grouped_summary$virus_label, receptors_virus_label_levels)

receptors_panel <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "right") +
  scale_y_log10(limits = c(0.3,1e2)) + 
  labs(x = element_blank(), y = "Fold increase\nto infection") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_point(data = receptors_grouped, aes(x = receptor_grouped, y = ace2dep_infection, color = virus_label), position = position_dodge(width = 0.8), alpha = 0.4) +
  geom_errorbar(data = receptors_grouped_summary, aes(x = receptor_grouped, ymin = lower_ci, ymax = upper_ci, color = virus_label), position = position_dodge(width = 0.8), alpha = 0.4, width = 0.2) +
  geom_point(data = receptors_grouped_summary, aes(x = receptor_grouped, y = geomean, color = virus_label), position = position_dodge(width = 0.8), size = 8, shape = 95)
receptors_panel
ggsave(file = "Plots/Receptors_panel.pdf", receptors_panel, height = 2, width = 5)
```

```{r Using a combination of mCherry and iRFP670 to test which proteins help enhance SARS1 or SARS2 pseudovirus entry}
## This time, don't group by receptor; Keep the differentially tagged constructs separated

receptors_ungrouped <- receptors %>% group_by(date, recombined_construct, virus_label) %>% 
  summarize(log10_nir_red_diff = mean(log10_nir_red_diff), pct_grn_gvn_red = mean(pct_grn_gvn_red), pct_grn_gvn_nir = mean(pct_grn_gvn_nir), .groups = "drop") %>% 
  mutate(n = 1, ace2dep_infection = 10^log10_nir_red_diff)

receptors_ungrouped_summary <- receptors_ungrouped %>% group_by(recombined_construct, virus_label) %>% 
  summarize(mean_log10_nir_red_diff = mean(log10_nir_red_diff), sd_log10_nir_red_diff = sd(log10_nir_red_diff), n = sum(n), .groups = "drop") %>% 
  mutate(se_log10_nir_red_diff = sd_log10_nir_red_diff / sqrt(n), geomean = 10^mean_log10_nir_red_diff, lower_ci = 10^(mean_log10_nir_red_diff - se_log10_nir_red_diff * 1.96), upper_ci = 10^(mean_log10_nir_red_diff + se_log10_nir_red_diff * 1.96))

receptors_ungrouped_summary$envelope <- factor(receptors_ungrouped_summary$virus_label, receptors_virus_label_levels)

receptors_panel2 <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "right") +
  scale_y_log10(limits = c(0.3,1e2)) + 
  labs(x = element_blank(), y = "Fold increase\nto infection") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_point(data = receptors_ungrouped, aes(x = recombined_construct, y = ace2dep_infection, color = virus_label), position = position_dodge(width = 0.8), alpha = 0.4) +
  geom_errorbar(data = receptors_ungrouped_summary, aes(x = recombined_construct, ymin = lower_ci, ymax = upper_ci, color = virus_label), position = position_dodge(width = 0.8), alpha = 0.4, width = 0.2) +
  geom_point(data = receptors_ungrouped_summary, aes(x = recombined_construct, y = geomean, color = virus_label), position = position_dodge(width = 0.8), size = 8, shape = 95)
receptors_panel2
ggsave(file = "Plots/Receptors_panel2.pdf", receptors_panel2, height = 2, width = 5)

## Now make a dataframe so I can do a comparative scatterplot
tagged_vs_untagged_receptors_dataframe <- 
  data.frame("gene" = c(rep("BSG",3),rep("NRP2",3),rep("CLEC4M",3),rep("ACE2",3)),
             "virus" = c(receptors_ungrouped_summary[1:12,"virus_label"]),
             "tagged" = c(subset(receptors_ungrouped_summary, recombined_construct == "[HA]BSG")$geomean,
                          subset(receptors_ungrouped_summary, recombined_construct == "Nrp2[HA]")$geomean,
                          subset(receptors_ungrouped_summary, recombined_construct == "[HA]CLEC4M")$geomean,
                          subset(receptors_ungrouped_summary, recombined_construct == "ACE2")$geomean),
             "untagged" = c(subset(receptors_ungrouped_summary, recombined_construct == "BSG")$geomean,
                          subset(receptors_ungrouped_summary, recombined_construct == "NRP2")$geomean,
                          subset(receptors_ungrouped_summary, recombined_construct == "CLEC4M")$geomean,
                          subset(receptors_ungrouped_summary, recombined_construct == "ACE2")$geomean))

Receptors_scatterplot <- ggplot() + theme_bw() + theme(panel.grid.minor = element_blank()) + 
  geom_abline(slope = 1, intercept = 0, alpha = 0.2, size = 4) +
  scale_x_log10() + scale_y_log10() + labs(x = "Untagged protein", y = "Tagged protein") +
  geom_point(data = tagged_vs_untagged_receptors_dataframe, aes(x = untagged, y = tagged, color = virus_label, shape = gene), size = 3)
Receptors_scatterplot
ggsave(file = "Plots/Receptors_scatterplot.pdf", Receptors_scatterplot, height = 3, width = 5)
```

## Allright, so now we can focus on ACE2
```{r Using a combination of mCherry and iRFP670 to test ACE2 enhancement}
two_color_ace2_dep <- two_color_combined %>% filter(expt == "Two_color" & pseudovirus_env != "none" & recombined_construct %in% c("G752A/G758A","G752A","G758A/G852C"))
two_color_ace2_dep$index <- seq(1,nrow(two_color_ace2_dep))
two_color_ace2_dep$log10_nir_red_diff <- log10(two_color_ace2_dep$moi_gvn_nir) - log10(two_color_ace2_dep$moi_gvn_red)

two_color_ace2_dep2 <- two_color_ace2_dep %>% group_by(date, virus_label) %>% 
  summarize(log10_nir_red_diff = mean(log10_nir_red_diff), pct_grn_gvn_red = mean(pct_grn_gvn_red), pct_grn_gvn_nir = mean(pct_grn_gvn_nir), ratio_nir_mcherry = mean(ratio_nir_mcherry), .groups = "drop") %>% 
  mutate(n = 1, ace2dep_infection = 10^log10_nir_red_diff)

two_color_ace2_dep_summary <- two_color_ace2_dep2 %>% group_by(virus_label) %>% 
  summarize(mean_log10_nir_red_diff = mean(log10_nir_red_diff), sd_log10_nir_red_diff = sd(log10_nir_red_diff), n = sum(n), .groups = "drop") %>%
  mutate(se_log10_nir_red_diff = sd_log10_nir_red_diff / sqrt(n), geomean = 10^mean_log10_nir_red_diff, lower_ci = 10^(mean_log10_nir_red_diff - se_log10_nir_red_diff * 1.96), upper_ci = 10^(mean_log10_nir_red_diff + se_log10_nir_red_diff * 1.96), cells = "ACE2")

two_color_ace2_dep_raw <- data.frame("virus_label" = c(two_color_ace2_dep2$virus_label,two_color_ace2_dep2$virus_label),
                                  "variable" = c(rep("nir",nrow(two_color_ace2_dep2)),rep("mCherry",nrow(two_color_ace2_dep2))),
                                  "value" = c(two_color_ace2_dep2$pct_grn_gvn_nir,two_color_ace2_dep2$pct_grn_gvn_red))
```


```{r}
diverse_virus_labels <- c("Vesicular stomatitis virus", "Ebolavirus Zaire","Marburgvirus","Lassa fever virus","Lymphocytic choriomeningitis virus","Junin virus","MERS-CoV", "SARS-CoV", "WIV1-CoV", "SARS-CoV-2")

## Show the raw infectivities first
diverse_virus_subset_raw <- two_color_ace2_dep_raw %>% filter(virus_label %in% diverse_virus_labels)
diverse_virus_subset_raw$virus_label <- factor(diverse_virus_subset_raw$virus_label, levels = diverse_virus_labels)

Diverse_virus_subset_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "none") +
  scale_y_log10() + #limits = c(1e-1,2e3)) + 
  scale_color_manual(values = c("red","black")) +
  labs(x = element_blank(), y = "Percent GFP positive cells") +
  geom_jitter(data = diverse_virus_subset_raw, aes(x = virus_label, y = value, color = variable), position = position_dodge(width = 0.4), alpha = 0.4) +
  geom_hline(yintercept = 0.005, linetype = 2)
Diverse_virus_subset_plot
ggsave(file = "Plots/Diverse_virus_subset_plot.pdf", Diverse_virus_subset_plot, height = 3, width = 4.5)

### Now look at the ACE2 dependent infection of each
diverse_virus_subset <- two_color_ace2_dep2 %>% filter(virus_label %in% diverse_virus_labels)
diverse_virus_subset$virus_label <- factor(diverse_virus_subset$virus_label, levels = diverse_virus_labels)
diverse_virus_subset_summary <- two_color_ace2_dep_summary %>% filter(virus_label %in% diverse_virus_labels)
diverse_virus_subset_summary$virus_label <- factor(diverse_virus_subset_summary$virus_label, levels = diverse_virus_labels)

Two_color_ACE2_dep_panel <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(1e-1,1e3)) + 
  labs(x = element_blank(), y = "Ratio of iRFP670 to mCherry infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_quasirandom(data = diverse_virus_subset, aes(x = virus_label, y = ace2dep_infection), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = diverse_virus_subset_summary, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = diverse_virus_subset_summary, aes(x = virus_label, y = geomean), size = 8, shape = 95)
Two_color_ACE2_dep_panel
ggsave(file = "Plots/Two_color_ACE2_dep_panel.pdf", Two_color_ACE2_dep_panel, height = 2.5, width = 4.5)

```

```{r RBD panel}
rbd_label_levels <- c("Junin virus", "SARS-CoV","SARS[WIV1 RBD]", "SARS[SARS-CoV-2 RBD]", "SARS[Rp3 RBD]", "SARS[YN2013 RBD]","SARS CoV (BtKY72 CoV RBD)", "SARS[BM48-31 RBD]", "SARS[BB9904 RBD]", "SARS[Rs4237 RBD]", "SARS[BtKY72 RBD]")

rbd_subset_raw <- two_color_ace2_dep_raw %>% filter(virus_label %in% rbd_label_levels)
rbd_subset_raw$virus_label <- factor(rbd_subset_raw$virus_label, levels = rbd_label_levels)

Rbd_subset_raw_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "none") +
  scale_y_log10() + #limits = c(1e-1,2e3)) + 
  scale_color_manual(values = c("red","black")) +
  labs(x = element_blank(), y = "Percent GFP positive cells") +
  geom_jitter(data = rbd_subset_raw, aes(x = virus_label, y = value, color = variable), position = position_dodge(width = 0.4), alpha = 0.4) +
  geom_hline(yintercept = 0.005, linetype = 2)
Rbd_subset_raw_plot
ggsave(file = "Plots/Rbd_subset_raw_plot.pdf", Rbd_subset_raw_plot, height = 3, width = 4.5)

rbd_subset2 <- two_color_ace2_dep2 %>% filter(virus_label %in% rbd_label_levels)
rbd_subset2$virus_label <- factor(rbd_subset2$virus_label, levels = rbd_label_levels)

rbd_subset_summary <- two_color_ace2_dep_summary %>% filter(virus_label %in% rbd_label_levels)
rbd_subset_summary$virus_label <- factor(rbd_subset_summary$virus_label, levels = rbd_label_levels)

Rbd_subset_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(1e-1,1e3)) + 
  labs(x = element_blank(), y = "Fold human ACE2\n-dependent infection") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_quasirandom(data = rbd_subset2, aes(x = virus_label, y = ace2dep_infection), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = rbd_subset_summary, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = rbd_subset_summary, aes(x = virus_label, y = geomean), size = 8, shape = 95)
Rbd_subset_plot
ggsave(file = "Plots/RBD_subset_plot.pdf", Rbd_subset_plot, height = 3, width = 4.5)
```

```{r Honing in on the BtKY72}
btky72_label_levels <- c("Junin virus", "SARS[BtKY72 RBD]", "SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]")
  
  #c("Junin virus", "SARS[BtKY72]", "SARS[BtKY72 329-539;Y488H]", "SARS[BtKY72 329-539;T499E]", "SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]", "SARS[BtKY72 1-120;329-539]", "SARS[BtKY72 112-206;329-539]", "SARS[BtKY72 214-328;329-539]")

btky72_subset_raw <- two_color_ace2_dep_raw %>% filter(virus_label %in% btky72_label_levels)
btky72_subset_raw$virus_label <- factor(btky72_subset_raw$virus_label, levels = btky72_label_levels)

btky72_subset_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "none") +
  scale_y_log10() + #limits = c(1e-1,2e3)) + 
  scale_color_manual(values = c("red","black")) +
  labs(x = element_blank(), y = "Percent GFP positive cells") +
  geom_jitter(data = btky72_subset_raw, aes(x = virus_label, y = value, color = variable), position = position_dodge(width = 0.4), alpha = 0.4) +
  geom_hline(yintercept = 0.005, linetype = 2)
btky72_subset_plot
ggsave(file = "Plots/btky72_subset_plot.pdf", btky72_subset_plot, height = 3, width = 4.5)

btky72_subset <- two_color_ace2_dep2 %>% filter(virus_label %in% btky72_label_levels)
btky72_subset$virus_label <- factor(btky72_subset$virus_label, levels = btky72_label_levels)

btky72_subset_summary <- two_color_ace2_dep_summary %>% filter(virus_label %in% btky72_label_levels)
btky72_subset_summary$virus_label <- factor(btky72_subset_summary$virus_label, levels = btky72_label_levels)

Ace2_btky72_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(1e-1,1e3)) + 
  labs(x = element_blank(), y = "Ratio of iRFP670 to mCherry infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_quasirandom(data = btky72_subset, aes(x = virus_label, y = ace2dep_infection), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = btky72_subset_summary, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = btky72_subset_summary, aes(x = virus_label, y = geomean), size = 8, shape = 95)
Ace2_btky72_plot
ggsave(file = "Plots/Ace2_btky72_plot.pdf", Ace2_btky72_plot, height = 2.5, width = 4.5)
```


## As an aside; now that I've processed all of the infection data, use all of it to see if there is a correlation between nir:mCherry ratio and Ace2-dependent infection
```{r See if observed ace2 dep infection correlates with the ratio of cells at all}
two_color_ace2_only <- receptors_grouped %>% filter(receptor_grouped == "ACE2") %>% select(virus_label, ratio_nir_mcherry, ace2dep_infection)
two_color_ace2_only2 <- two_color_ace2_dep2 %>% filter(virus_label %in% receptors_virus_label_levels) %>% select(virus_label, ratio_nir_mcherry, ace2dep_infection)

two_color_ace2_only_combined <- rbind(two_color_ace2_only, two_color_ace2_only2)

two_color_ace2_only_combined_vsv <- two_color_ace2_only_combined %>% filter(virus_label == "Vesicular stomatitis virus") %>% mutate(log10_ace2dep_infxn = log10(ace2dep_infection), log_ratio_nir_mcherry = log10(ratio_nir_mcherry))
two_color_ace2_only_combined_vsv_lm <- lm(two_color_ace2_only_combined_vsv$log10_ace2dep_infxn ~ two_color_ace2_only_combined_vsv$log_ratio_nir_mcherry)

ggplot() + geom_point(data = two_color_ace2_only_combined_vsv, aes(x = ratio_nir_mcherry, y = log10_ace2dep_infxn)) +
  geom_abline(slope = two_color_ace2_only_combined_vsv_lm$coefficient[2], intercept = two_color_ace2_only_combined_vsv_lm$coefficient[1], color = "blue", linetype = 2)

two_color_ace2_only_combined_sars <- two_color_ace2_only_combined %>% filter(virus_label == "SARS-CoV") %>% mutate(log10_ace2dep_infxn = log10(ace2dep_infection), log_ratio_nir_mcherry = log10(ratio_nir_mcherry))
two_color_ace2_only_combined_sars_lm <- lm(two_color_ace2_only_combined_sars$log10_ace2dep_infxn ~ two_color_ace2_only_combined_sars$log_ratio_nir_mcherry)

ggplot() + geom_point(data = two_color_ace2_only_combined_sars, aes(x = ratio_nir_mcherry, y = log10_ace2dep_infxn)) +
  geom_abline(slope = two_color_ace2_only_combined_sars_lm$coefficient[2], intercept = two_color_ace2_only_combined_sars_lm$coefficient[1], color = "blue", linetype = 2)

two_color_ace2_only_combined_sars2 <- two_color_ace2_only_combined %>% filter(virus_label == "SARS-CoV-2") %>% mutate(log10_ace2dep_infxn = log10(ace2dep_infection), log_ratio_nir_mcherry = log10(ratio_nir_mcherry))
two_color_ace2_only_combined_sars2_lm <- lm(two_color_ace2_only_combined_sars2$log10_ace2dep_infxn ~ two_color_ace2_only_combined_sars2$log_ratio_nir_mcherry)

ggplot() + geom_point(data = two_color_ace2_only_combined_sars2, aes(x = log_ratio_nir_mcherry, y = log10_ace2dep_infxn)) +
  geom_abline(slope = two_color_ace2_only_combined_sars2_lm$coefficient[2], intercept = two_color_ace2_only_combined_sars2_lm$coefficient[1], color = "blue", linetype = 2)

ggplot() + scale_y_log10() + scale_x_log10() + 
  geom_abline(slope = two_color_ace2_only_combined_vsv_lm$coefficient[2], intercept = two_color_ace2_only_combined_vsv_lm$coefficient[1], color = "red", linetype = 2) + 
  geom_abline(slope = two_color_ace2_only_combined_sars_lm$coefficient[2], intercept = two_color_ace2_only_combined_sars_lm$coefficient[1], color = "dark green", linetype = 2) + 
  geom_abline(slope = two_color_ace2_only_combined_sars2_lm$coefficient[2], intercept = two_color_ace2_only_combined_sars2_lm$coefficient[1], color = "blue", linetype = 2) +
  geom_point(data = two_color_ace2_only_combined, aes(x = ratio_nir_mcherry, y = ace2dep_infection, color = virus_label))

```

## OK, so maybe we can increase our sensitivity by adding TMPRSS2 into the mix
```{r See what the differences are between }
two_color_ace2_tmprss2_dep <- two_color_combined %>% filter(expt == "Two_color_ACE2_TMPRSS2" & pseudovirus_env != "none")
two_color_ace2_tmprss2_dep$index <- seq(1,nrow(two_color_ace2_tmprss2_dep))
two_color_ace2_tmprss2_dep$log10_nir_red_diff <- log10(two_color_ace2_tmprss2_dep$moi_gvn_nir) - log10(two_color_ace2_tmprss2_dep$moi_gvn_red)

two_color_ace2_tmprss2_dep2 <- two_color_ace2_tmprss2_dep %>% group_by(date, virus_label) %>% 
  summarize(log10_nir_red_diff = mean(log10_nir_red_diff), pct_grn_gvn_red = mean(pct_grn_gvn_red), pct_grn_gvn_nir = mean(pct_grn_gvn_nir), .groups = "drop") %>% 
  mutate(ace2_tmprss2_dep_infection = 10^log10_nir_red_diff, n = 1)

two_color_ace2_tmprss2_dep_summary <- two_color_ace2_tmprss2_dep2 %>% group_by(virus_label) %>% 
  summarize(mean_log10_nir_red_diff = mean(log10_nir_red_diff), sd_log10_nir_red_diff = sd(log10_nir_red_diff), n = sum(n), .groups = "drop") %>%
  mutate(se_log10_nir_red_diff = sd_log10_nir_red_diff / sqrt(n), geomean = 10^mean_log10_nir_red_diff, lower_ci = 10^(mean_log10_nir_red_diff - se_log10_nir_red_diff * 1.96), upper_ci = 10^(mean_log10_nir_red_diff + se_log10_nir_red_diff * 1.96), cells = "ACE2")

## Compare the control viruses with ACE2 dependent enhancement or ACE2 + TMPRSS2 dependent enhancement
two_color_ace2_dep_summary_controls <- two_color_ace2_dep_summary %>% filter(virus_label %in% c("Junin virus", "SARS-CoV", "SARS[SARS-CoV-2 RBD]"))
two_color_ace2_tmprss2_dep_summary_controls <- two_color_ace2_tmprss2_dep_summary %>% filter(virus_label %in% c("Junin virus", "SARS-CoV", "SARS[SARS-CoV-2 RBD]"))
ace2_with_tmprss2_controls <- merge(two_color_ace2_dep_summary_controls[,c("virus_label","geomean")], two_color_ace2_tmprss2_dep_summary_controls[,c("virus_label","geomean")], by = "virus_label")
colnames(ace2_with_tmprss2_controls) <- c("virus_label","ace2","ace2tmprss2")

## Weird. Maybe the values were maxed out or something?
```


```{r Looking at the RBD panel with ACE2 and TMPRSS2}
two_color_ace2_tmprss2_dep2_rbds <- two_color_ace2_tmprss2_dep2 %>% filter(virus_label %in% rbd_label_levels)
two_color_ace2_tmprss2_dep2_rbds$virus_label <- factor(two_color_ace2_tmprss2_dep2_rbds$virus_label, levels = rbd_label_levels)

two_color_ace2_tmprss2_dep_summary_rbds<- two_color_ace2_tmprss2_dep_summary %>% filter(virus_label %in% rbd_label_levels)
two_color_ace2_tmprss2_dep_summary_rbds$virus_label <- factor(two_color_ace2_tmprss2_dep_summary_rbds$virus_label, levels = rbd_label_levels)

ACE2_TMPRSS2_RBDs_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(1e-1,1e3)) + 
  labs(x = element_blank(), y = "Ratio of mCherry to iRFP670 infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_quasirandom(data = two_color_ace2_tmprss2_dep2_rbds, aes(x = virus_label, y = ace2_tmprss2_dep_infection), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = two_color_ace2_tmprss2_dep_summary_rbds, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = two_color_ace2_tmprss2_dep_summary_rbds, aes(x = virus_label, y = geomean), size = 8, shape = 95)
ACE2_TMPRSS2_RBDs_plot
ggsave(file = "Plots/ACE2_TMPRSS2_RBDs_plot.pdf", ACE2_TMPRSS2_RBDs_plot, height = 2.5, width = 4.5)

two_color_ace2_dep_summary_rbds <- two_color_ace2_dep_summary %>% filter(virus_label %in% c("Junin virus", "SARS-CoV","SARS[WIV1 RBD]", "SARS[SARS-CoV-2 RBD]", "SARS[Rp3 RBD]", "SARS[YN2013 RBD]","SARS CoV (BtKY72 CoV RBD)", "SARS[BM48-31 RBD]", "SARS[BB9904 RBD]", "SARS[Rs4237 RBD]", "SARS[BtKY72 RBD]"))
two_color_ace2_tmprss2_dep_summary_rbds <- two_color_ace2_tmprss2_dep_summary %>% filter(virus_label %in% c("Junin virus", "SARS-CoV","SARS[WIV1 RBD]", "SARS[SARS-CoV-2 RBD]", "SARS[Rp3 RBD]", "SARS[YN2013 RBD]","SARS CoV (BtKY72 CoV RBD)", "SARS[BM48-31 RBD]", "SARS[BB9904 RBD]", "SARS[Rs4237 RBD]", "SARS[BtKY72 RBD]"))
ace2_with_tmprss2_rbds <- merge(two_color_ace2_dep_summary_rbds[,c("virus_label","geomean")], two_color_ace2_tmprss2_dep_summary_rbds[,c("virus_label","geomean")], by = "virus_label")
colnames(ace2_with_tmprss2_rbds) <- c("virus_label","ace2","ace2tmprss2")

ggplot() + theme_bw() + scale_x_log10() + scale_y_log10() +
  geom_abline(slope = 1, intercept = 0, alpha = 0.2, size = 4) +
  geom_text_repel(data = ace2_with_tmprss2_rbds, aes(x = ace2, y = ace2tmprss2, label = virus_label), color = "red", segment.color = "orange") +
  geom_point(data = ace2_with_tmprss2_rbds, aes(x = ace2, y = ace2tmprss2))
```

```{r Looking at the BtKY72 panel with ACE2 and TMPRSS2}
btky72_label_levels2 <- c("Junin virus", "SARS[BtKY72 RBD]", "SARS[BtKY72 329-539;Y488H]", "SARS[BtKY72 329-539;T499E]", "SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]")

two_color_ace2_tmprss2_dep2_btky72 <- two_color_ace2_tmprss2_dep2 %>% filter(virus_label %in% btky72_label_levels2) 
two_color_ace2_tmprss2_dep2_btky72$virus_label <- factor(two_color_ace2_tmprss2_dep2_btky72$virus_label, levels = btky72_label_levels2)

two_color_ace2_tmprss2_dep_summary_btky72<- two_color_ace2_tmprss2_dep_summary %>% filter(virus_label %in% btky72_label_levels2) 
two_color_ace2_tmprss2_dep_summary_btky72$virus_label <- factor(two_color_ace2_tmprss2_dep_summary_btky72$virus_label, levels = btky72_label_levels2)

ACE2_TMPRSS2_btky72_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(1e-1,1e3)) + 
  labs(x = element_blank(), y = "Ratio of mCherry to iRFP670 infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_quasirandom(data = two_color_ace2_tmprss2_dep2_btky72, aes(x = virus_label, y = ace2_tmprss2_dep_infection), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = two_color_ace2_tmprss2_dep_summary_btky72, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = two_color_ace2_tmprss2_dep_summary_btky72, aes(x = virus_label, y = geomean), size = 12, shape = 95)
ACE2_TMPRSS2_btky72_plot
ggsave(file = "Plots/ACE2_TMPRSS2_btky72_plot.pdf", ACE2_TMPRSS2_btky72_plot, height = 2.5, width = 4.5)

two_color_ace2_dep_summary_btky72 <- two_color_ace2_dep_summary %>% filter(virus_label %in% c("Junin virus", "SARS[BtKY72 RBD]", "SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]","SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]", "SARS[BtKY72 1-120;329-539]", "SARS[BtKY72 112-206;329-539]", "SARS[BtKY72 214-328;329-539]"))
two_color_ace2_tmprss2_dep_summary_btky72 <- two_color_ace2_tmprss2_dep_summary %>% filter(virus_label %in% c("Junin virus", "SARS[BtKY72 RBD]", "SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]","SARS[BtKY72 1-539]", "SARS[BtKY72 1-888]", "SARS[BtKY72 1-955]", "SARS[BtKY72 1-120;329-539]", "SARS[BtKY72 112-206;329-539]", "SARS[BtKY72 214-328;329-539]"))
ace2_with_tmprss2_btky72 <- merge(two_color_ace2_dep_summary_btky72[,c("virus_label","geomean")], two_color_ace2_tmprss2_dep_summary_btky72[,c("virus_label","geomean")], by = "virus_label")
colnames(ace2_with_tmprss2_btky72) <- c("virus_label","ace2","ace2tmprss2")

ggplot() + theme_bw() + scale_x_log10() + scale_y_log10() +
  geom_abline(slope = 1, intercept = 0, alpha = 0.2, size = 4) +
  geom_text_repel(data = ace2_with_tmprss2_btky72, aes(x = ace2, y = ace2tmprss2, label = virus_label), color = "red", segment.color = "orange") +
  geom_point(data = ace2_with_tmprss2_btky72, aes(x = ace2, y = ace2tmprss2))
  
```


















```{r}


two_color_ace2_tmprss23 <- two_color_ace2_tmprss22 #merge(two_color_ace2_tmprss22, pseudovirus_label_key, by = "pseudovirus_env", all.x = T)

two_color_ace2_tmprss24 <- data.frame("virus_label" = c(two_color_ace2_tmprss23$virus_label,two_color_ace2_tmprss23$virus_label),
                                  "variable" = c(rep("nir",nrow(two_color_ace2_tmprss23)),rep("mCherry",nrow(two_color_ace2_tmprss23))),
                                  "value" = c(two_color_ace2_tmprss23$pct_grn_gvn_nir,two_color_ace2_tmprss23$pct_grn_gvn_red))

#two_color_virus_label_levels <- c("Vesicular stomatitis virus", "SARS CoV", "WIV1 CoV", "SARS CoV-2","NL63 CoV","MERS CoV","HKU4 CoV","Ebolavirus Zaire","Marburgvirus","Lassa fever virus","Lymphocytic choriomeningitis virus","Junin virus","SARS CoV (WIV1 CoV RBD)", "SARS CoV(SARS CoV-2 RBD)", "SARS CoV (Rp3 CoV RBD)", "SARS CoV (YN2013 CoV RBD)", "SARS CoV (Rs4237 CoV RBD)","SARS CoV (BtKY72 CoV RBD)", "SARS CoV (BB9904 CoV RBD)", "SARS CoV (BM48-31 CoV RBD)", "BtKY72(1-539)_SARS CoV", "BtKY72(1-888)_SARS CoV", "BtKY72(1-955)_SARS CoV")


#two_color_ace2_tmprss24$virus_label <- factor(two_color_ace2_tmprss24$virus_label, levels = two_color_virus_label_levels)

Two_color_pct_gfp_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "none") +
  scale_y_log10() + #limits = c(1e-1,2e3)) + 
  scale_color_manual(values = c("red","black")) +
  labs(x = element_blank(), y = "Percent GFP positive cells") +
  geom_jitter(data = two_color_ace2_tmprss24, aes(x = virus_label, y = value, color = variable), position = position_dodge(width = 0.4), alpha = 0.4) +
  geom_hline(yintercept = 0.005, linetype = 2)
Two_color_pct_gfp_plot
ggsave(file = "Plots/Two_color_pct_gfp_plot.pdf", Two_color_pct_gfp_plot, height = 3, width = 4.5)















```










# This is comparing ACE2 vs ACE2-2A-TMPRSS2, so the effects are small!
```{r Seeing how ACE2-2A-TMPRSS2 works as compared to ACE2 alone}
ace2_tmprss2_dep <- two_color_combined %>% filter(expt == "ACE2_TMPRSS2" & !(is.na(pseudovirus_env) | pseudovirus_env == "None"))
ace2_tmprss2_dep$index <- seq(1,nrow(ace2_tmprss2_dep))
ace2_tmprss2_dep$log10_red_nir_diff <- log10(ace2_tmprss2_dep$moi_gvn_red) - log10(ace2_tmprss2_dep$moi_gvn_nir)

ace2_tmprss2_dep2 <- ace2_tmprss2_dep %>% group_by(date, virus_label) %>% summarize(log10_red_nir_diff = mean(log10_red_nir_diff), pct_grn_gvn_red = mean(pct_grn_gvn_red), pct_grn_gvn_nir = mean(pct_grn_gvn_nir), .groups = "drop") %>% mutate(n = 1, ace2dep_infection = 10^log10_red_nir_diff)

ace2_tmprss2_dep_summary <- ace2_tmprss2_dep2 %>% group_by(virus_label) %>% 
  summarize(mean_log10_red_nir_diff = mean(log10_red_nir_diff), sd_log10_red_nir_diff = sd(log10_red_nir_diff), n = sum(n), .groups = "drop") %>%
  mutate(se_log10_red_nir_diff = sd_log10_red_nir_diff / sqrt(n), geomean = 10^mean_log10_red_nir_diff, lower_ci = 10^(mean_log10_red_nir_diff - se_log10_red_nir_diff * 1.96), upper_ci = 10^(mean_log10_red_nir_diff + se_log10_red_nir_diff * 1.96), cells = "ACE2-2A-TMPRSS2")

ace2_tmprss2_summary2 <- ace2_tmprss2_dep_summary #merge(ace2_tmprss2__summary, pseudovirus_label_key, by = "pseudovirus_env", all.x = T)
ace2_tmprss2_summary2[ace2_tmprss2_summary2$virus_label == "MERS CoV","lower_ci"] <- 1e-1

Two_color_panel <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(3e-1,1e1)) + 
  labs(x = element_blank(), y = "Ratio of iRFP670 to mCherry infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_jitter(data = ace2_tmprss2_dep2, aes(x = virus_label, y = ace2dep_infection), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = ace2_tmprss2_summary2, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = ace2_tmprss2_summary2, aes(x = virus_label, y = geomean), size = 8, shape = 95)
Two_color_panel
ggsave(file = "Plots/ACE2_with_without_TMPRSS2.pdf", Two_color_panel, height = 2.5, width = 4.5)
```





```{r Using a combination of mCherry and iRFP670 to test ACE2 enhancement}
two_color_ace2_tmprss2 <- two_color_combined %>% filter(expt == "Two_color_ACE2_TMPRSS2" & pseudovirus_env != "none")
two_color_ace2_tmprss2$index <- seq(1,nrow(two_color_ace2_tmprss2))

two_color_ace2_tmprss2$log10_nir_red_diff <- log10(two_color_ace2_tmprss2$moi_gvn_nir) - log10(two_color_ace2_tmprss2$moi_gvn_red)

for(x in 1:nrow(two_color_ace2_tmprss2)){two_color_ace2_tmprss2$vsv_norm_log10_diff[x] <- two_color_ace2_tmprss2$log10_nir_red_diff[x] - mean(two_color_ace2_tmprss2[two_color_ace2_tmprss2$pseudovirus_env == "VSVG" & two_color_ace2_tmprss2$date ==  two_color_ace2_tmprss2$date[x],"log10_nir_red_diff"])}

two_color_ace2_tmprss22 <- two_color_ace2_tmprss2 %>% group_by(date, virus_label) %>% summarize(log10_nir_red_diff = mean(log10_nir_red_diff), pct_grn_gvn_red = mean(pct_grn_gvn_red), pct_grn_gvn_nir = mean(pct_grn_gvn_nir))
two_color_ace2_tmprss22$vsv_norm <- 10^two_color_ace2_tmprss22$log10_nir_red_diff
two_color_ace2_tmprss22$count <- 1

two_color_ace2_tmprss2_summary <- two_color_ace2_tmprss22 %>% group_by(virus_label) %>% summarize(mean_log10 = mean(log10_nir_red_diff), sd_log10 = sd(log10_nir_red_diff), n = sum(count))
two_color_ace2_tmprss2_summary$geomean = 10^two_color_ace2_tmprss2_summary$mean_log10
two_color_ace2_tmprss2_summary$upper_ci <- 10^(two_color_ace2_tmprss2_summary$mean_log10 + two_color_ace2_tmprss2_summary$sd_log10/sqrt(two_color_ace2_tmprss2_summary$n - 1)*1.96)
two_color_ace2_tmprss2_summary$lower_ci <- 10^(two_color_ace2_tmprss2_summary$mean_log10 - two_color_ace2_tmprss2_summary$sd_log10/sqrt(two_color_ace2_tmprss2_summary$n - 1)*1.96)

two_color_ace2_tmprss23 <- two_color_ace2_tmprss22 #merge(two_color_ace2_tmprss22, pseudovirus_label_key, by = "pseudovirus_env", all.x = T)

two_color_ace2_tmprss24 <- data.frame("virus_label" = c(two_color_ace2_tmprss23$virus_label,two_color_ace2_tmprss23$virus_label),
                                  "variable" = c(rep("nir",nrow(two_color_ace2_tmprss23)),rep("mCherry",nrow(two_color_ace2_tmprss23))),
                                  "value" = c(two_color_ace2_tmprss23$pct_grn_gvn_nir,two_color_ace2_tmprss23$pct_grn_gvn_red))

#two_color_virus_label_levels <- c("Vesicular stomatitis virus", "SARS CoV", "WIV1 CoV", "SARS CoV-2","NL63 CoV","MERS CoV","HKU4 CoV","Ebolavirus Zaire","Marburgvirus","Lassa fever virus","Lymphocytic choriomeningitis virus","Junin virus","SARS CoV (WIV1 CoV RBD)", "SARS CoV(SARS CoV-2 RBD)", "SARS CoV (Rp3 CoV RBD)", "SARS CoV (YN2013 CoV RBD)", "SARS CoV (Rs4237 CoV RBD)","SARS CoV (BtKY72 CoV RBD)", "SARS CoV (BB9904 CoV RBD)", "SARS CoV (BM48-31 CoV RBD)", "BtKY72(1-539)_SARS CoV", "BtKY72(1-888)_SARS CoV", "BtKY72(1-955)_SARS CoV")


#two_color_ace2_tmprss24$virus_label <- factor(two_color_ace2_tmprss24$virus_label, levels = two_color_virus_label_levels)

Two_color_pct_gfp_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "none") +
  scale_y_log10() + #limits = c(1e-1,2e3)) + 
  scale_color_manual(values = c("red","black")) +
  labs(x = element_blank(), y = "Percent GFP positive cells") +
  geom_jitter(data = two_color_ace2_tmprss24, aes(x = virus_label, y = value, color = variable), position = position_dodge(width = 0.4), alpha = 0.4) +
  geom_hline(yintercept = 0.005, linetype = 2)
Two_color_pct_gfp_plot
ggsave(file = "Plots/Two_color_pct_gfp_plot.pdf", Two_color_pct_gfp_plot, height = 3, width = 4.5)

#two_color_ace2_tmprss23$virus_label <- factor(two_color_ace2_tmprss23$virus_label, two_color_virus_label_levels)

two_color_ace2_tmprss2_summary2 <- two_color_ace2_tmprss2_summary #merge(two_color_ace2_tmprss2_summary, pseudovirus_label_key, by = "pseudovirus_env", all.x = T)
#two_color_ace2_tmprss2_summary2$virus_label <- factor(two_color_ace2_tmprss2_summary2$virus_label, two_color_virus_label_levels)

Two_color_ace2_tmprss2_dep_panel_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(5e-2,2e3)) + 
  labs(x = element_blank(), y = "Ratio of iRFP670 to mCherry infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_jitter(data = two_color_ace2_tmprss23, aes(x = virus_label, y = vsv_norm, color = date), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = two_color_ace2_tmprss2_summary2, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = two_color_ace2_tmprss2_summary2, aes(x = virus_label, y = geomean), size = 8, shape = 95)
Two_color_ace2_tmprss2_dep_panel_plot
ggsave(file = "Plots/Two_color_ace2_tmprss2_dep_panel_plot.pdf", Two_color_ace2_tmprss2_dep_panel_plot, height = 2.5, width = 4.5)
```


















```{r Compare how the one-color and two-color assays perform}
# One-color data
one_color_precombined <- combined_infection %>% filter(expt == "One_color_ACE2_TMPRSS2" & !(is.na(pseudovirus_env) | pseudovirus_env == "None"))
## Make sure I ignore data where I didn't run enough cells to make a conclusion
one_color_precombined$lower_bound_red <- 10^(log10(one_color_precombined$live_singlets * one_color_precombined$pct_red / 100)*-0.99 + 2.64)
one_color_precombined$passes_lower_bound <- "no"
one_color_precombined$passes_upper_bound <- "no"
for(x in 1:nrow(one_color_precombined)){
  if(one_color_precombined$lower_bound_red[x] <= one_color_precombined$pct_grn_gvn_red[x]){one_color_precombined$passes_lower_bound[x] <- "yes"}
  if(one_color_precombined$pct_grn_gvn_red[x] <= 60){one_color_precombined$passes_upper_bound[x] <- "yes"}
}
one_color_combined <- merge(one_color_precombined %>% filter(passes_lower_bound == "yes" & passes_upper_bound == "yes"), pseudovirus_label_key, by = "pseudovirus_env", all.x = T)

one_color_combined_summary <- data.frame(unique(one_color_combined[,c("virus_label","date")]))

one_color_combined_summary$ace2_dependence <- NA
for(x in 1:nrow(one_color_combined_summary)){
  temp_date <- one_color_combined_summary$date[x]
  temp_env <- one_color_combined_summary$virus_label[x]
  one_color_combined_summary$ace2_dependence[x] <- mean(one_color_combined[one_color_combined$date == temp_date & one_color_combined$virus_label == temp_env & one_color_combined$recombined_construct == "G828A", "moi_gvn_red"]) / mean(one_color_combined[one_color_combined$date == temp_date & one_color_combined$virus_label == temp_env & one_color_combined$recombined_construct == "G758A", "moi_gvn_red"])
}

ggplot() + theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + labs(x = NULL, y= "MOI") +
  scale_y_log10() +
  geom_point(data = one_color_combined, aes(x = virus_label, y = moi_gvn_red, color = recombined_construct), position = position_dodge(width = 0.5))

one_color_combined_summary2 <- one_color_combined_summary %>% 
  filter(virus_label %in% c("SARS-CoV-2","SARS-CoV","Junin virus")) %>% 
  mutate(count = 1, log_ace2dep = log10(ace2_dependence)) %>% group_by(virus_label) %>% 
  summarize(mean_log_ace2dep = mean(log_ace2dep), sd_log_ace2dep = sd(log_ace2dep), count = sum(count), .groups = "drop") %>% 
  mutate(se_log_ace2dep = sd_log_ace2dep / sqrt(count), geomean = 10^mean_log_ace2dep, upper_ci = 10^(mean_log_ace2dep + se_log_ace2dep * 1.96), lower_ci = 10^(mean_log_ace2dep - se_log_ace2dep * 1.96))

One_color_ace2_tmprss2_dep_panel_plot <- ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_log10(limits = c(5e-2,2e3)) + 
  labs(x = element_blank(), y = "Ratio of iRFP670 to mCherry infected cells") +
  geom_hline(yintercept = 1, linetype = 2, alpha = 0.4) +
  geom_jitter(data = one_color_combined_summary, aes(x = virus_label, y = ace2_dependence), position = position_jitter(width = 0.1), alpha = 0.4) +
  geom_errorbar(data = one_color_combined_summary2, aes(x = virus_label, ymin = lower_ci, ymax = upper_ci), alpha = 0.4, width = 0.2) +
  geom_point(data = one_color_combined_summary2, aes(x = virus_label, y = geomean), size = 8, shape = 95)
One_color_ace2_tmprss2_dep_panel_plot
```






```{r Letko data}
d1e_bhkace2 <- read.csv(file = "Data/Letko/1e_bhkace2.csv", header = T, stringsAsFactors = F)
d2a_vero_notrypsin <- read.csv(file = "Data/Letko/2a_vero_notrypsin.csv", header = T, stringsAsFactors = F)
d2a_vero_trypsin <- read.csv(file = "Data/Letko/2a_vero_trypsin.csv", header = T, stringsAsFactors = F)
d2b_caco2_notrypsin <- read.csv(file = "Data/Letko/2b_caco2_notrypsin.csv", header = T, stringsAsFactors = F)
d2b_caco2_trypsin <- read.csv(file = "Data/Letko/2b_caco2_trypsin.csv", header = T, stringsAsFactors = F)
d2b_huh_notrypsin <- read.csv(file = "Data/Letko/2b_huh_notrypsin.csv", header = T, stringsAsFactors = F)
d2b_huh_trypsin <- read.csv(file = "Data/Letko/2b_huh_trypsin.csv", header = T, stringsAsFactors = F)
d3b_bhkace2_notrypsin <- read.csv(file = "Data/Letko/3b_bhkace2_notrypsin.csv", header = T, stringsAsFactors = F)
d3b_bhkace2_trypsin <- read.csv(file = "Data/Letko/3b_bhkace2_trypsin.csv", header = T, stringsAsFactors = F)

letko_combined <- merge(d1e_bhkace2, d2a_vero_notrypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d2a_vero_notrypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d2b_caco2_notrypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d2b_caco2_trypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d2b_huh_notrypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d2b_huh_trypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d3b_bhkace2_notrypsin, by = "X", all = T)
letko_combined <- merge(letko_combined, d3b_bhkace2_trypsin, by = "X", all = T)

for(x in 1:nrow(letko_combined)){
  for(y in 2:ncol(letko_combined)){
    if(is.na(letko_combined[x,y])){letko_combined[x,y] <- NA}
    else{letko_combined[x,y] <- log10(letko_combined[x,y])}
  }
}

letko_melt <- melt(letko_combined, id = "X")
letko_melt$count <- 1

letko_summarized <- letko_melt %>% filter(!is.na(value)) %>% group_by(X) %>% summarize(mean = mean(value, na.rm = T), sd = sd(value, na.rm = T), count = sum(count))
letko_summarized$se <- letko_summarized$sd / sqrt(letko_summarized$count - 1)
letko_summarized$upper_ci <- letko_summarized$mean + letko_summarized$se * 1.96
letko_summarized$lower_ci <- letko_summarized$mean - letko_summarized$se * 1.96

letko_summarized$X <- factor(letko_summarized$X, phylo_ordering2 <- c("VSV-g","None","SARS-S WT","WIV1","LYRa11","Rs7327","Rs4231","Rs4084","SHC014","As6526","Yunnan2011","Shaanxi2011","279-2005","Rs4237","Rs4081","Rp3","Rs4247","HKU3-8","HKU3-13","GX2013","Longquan-140","YN2013","Rf4092","ZXC21","ZC45","JL2012","HuB2013","KF294457","Rf1","HeB2013","273-2005","BM48-31"))

ggplot() + 
  theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(x = NULL, y = "Scaled infectivity") +
  geom_errorbar(data = letko_summarized, aes(x = X, ymin = lower_ci, ymax = upper_ci)) +
  geom_point(data = letko_summarized, aes(x = X, y = mean))
```

```{r Cladogram of RBDs}
library(phytools)

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
#BiocManager::install("ggtree")  ## You may need to run this
library(ggtree) #https://yulab-smu.github.io/treedata-book/chapter4.html

rbd_tree <- read.newick(file = "Data/Alignment/SL_CoV_RBDs.nwk")  #You need phytools for this

receptor_usage_table <- read.csv(file = "Data/Alignment/receptor_usage_table.csv", header = T, stringsAsFactors = F)
receptor_usage_table$label <- gsub(">","",receptor_usage_table$label)
label_dataframe <- merge(data.frame("label" = gsub("'","",rbd_tree$tip.label)), receptor_usage_table, by = "label", all = T)
#label_dataframe$label <- paste("'",label_dataframe$label,"'",sep="")

#ggtree(tr = rbd_tree) + xlim(0, 0.42) + geom_tiplab(angle = 0, size = 2)

## Follow info on this link for coloring tips based on receptor usage https://aschuerch.github.io/posts/2017-04-24-blog-post-1
p <- ggtree(tr = rbd_tree) + xlim(0, 0.75) #xlim(0, 2) #
p2 <- p %<+% label_dataframe + 
  geom_tiplab(aes(fill = receptor),
              color = "black", # color for label font
              geom = "label",  # labels not text
              label.padding = unit(0.15, "lines"), # amount of padding around the labels
              label.size = 0,
              size = 2)  + # size of label border)
  theme(legend.position = "none") +
  scale_fill_manual(values = c("grey80","lavender","white"))

ggsave(file = "Plots/SARS-like_CoV_RBDs.pdf", p2, height = 5*0.5, width = 7.5*0.5)
p2
```

```{r Bat ACE2 sequences}

ace2_tree <- read.newick(file = "Data/Alignment/Bat_ACE2.nwk")  #You need phytools for this

p <- ggtree(tr = ace2_tree) + xlim(0, 0.75) #xlim(0, 2) #
p2 <- p %<+% label_dataframe + 
  geom_tiplab(color = "black", # color for label font
              geom = "label",  # labels not text
              label.padding = unit(0.15, "lines"), # amount of padding around the labels
              label.size = 0,
              size = 2)  + # size of label border)
  theme(legend.position = "none")
p2






```

